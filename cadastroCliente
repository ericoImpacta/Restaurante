from flask import Flask, request, jsonify
import mysql.connector
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

# Conexão com MySQL
db = mysql.connector.connect(
    host="localhost",
    user="root",           # seu usuário MySQL
    password="Eagles6-",  # sua senha MySQL
    database="restaurante_db"
)
cursor = db.cursor(dictionary=True)

# Criar tabelas se não existirem
cursor.execute("""
CREATE TABLE IF NOT EXISTS clientes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100),
    email VARCHAR(100)
)
""")

cursor.execute("""
CREATE TABLE IF NOT EXISTS restaurantes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100),
    endereco VARCHAR(200)
)
""")

cursor.execute("""
CREATE TABLE IF NOT EXISTS pratos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100),
    preco DECIMAL(10,2),
    restaurante_id INT,
    FOREIGN KEY (restaurante_id) REFERENCES restaurantes(id)
)
""")

cursor.execute("""
CREATE TABLE IF NOT EXISTS pedidos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    cliente_id INT,
    restaurante_id INT,
    prato_id INT,
    FOREIGN KEY (cliente_id) REFERENCES clientes(id),
    FOREIGN KEY (restaurante_id) REFERENCES restaurantes(id),
    FOREIGN KEY (prato_id) REFERENCES pratos(id)
)
""")
db.commit()

# ---------- Rotas ----------

# Cadastro Cliente
@app.route("/cadastro/cliente", methods=["POST"])
def cadastrar_cliente():
    data = request.json
    cursor.execute("INSERT INTO clientes (nome, email) VALUES (%s, %s)", (data["nome"], data["email"]))
    db.commit()
    return jsonify({"mensagem": "Realizado com Sucesso"}), 201

# Cadastro Restaurante
@app.route("/cadastro/restaurante", methods=["POST"])
def cadastrar_restaurante():
    data = request.json
    cursor.execute("INSERT INTO restaurantes (nome, endereco) VALUES (%s, %s)", (data["nome"], data["endereco"]))
    db.commit()
    return jsonify({"mensagem": "Realizado com Sucesso"}), 201

# Cadastro Prato
@app.route("/cadastro/prato", methods=["POST"])
def cadastrar_prato():
    data = request.json
    cursor.execute("SELECT id FROM restaurantes WHERE nome = %s", (data["restaurante_nome"],))
    restaurante = cursor.fetchone()
    if not restaurante:
        return jsonify({"erro": "Restaurante não encontrado"}), 400
    cursor.execute("INSERT INTO pratos (nome, preco, restaurante_id) VALUES (%s, %s, %s)",
                   (data["nome"], data["preco"], restaurante["id"]))
    db.commit()
    return jsonify({"mensagem": "Realizado com Sucesso"}), 201

# Realizar Pedido
@app.route("/pedido", methods=["POST"])
def realizar_pedido():
    data = request.json

    cursor.execute("SELECT id FROM clientes WHERE nome = %s", (data["cliente_nome"],))
    cliente = cursor.fetchone()
    if not cliente:
        return jsonify({"erro": "Cliente não encontrado"}), 400

    cursor.execute("SELECT id FROM restaurantes WHERE nome = %s", (data["restaurante_nome"],))
    restaurante = cursor.fetchone()
    if not restaurante:
        return jsonify({"erro": "Restaurante não encontrado"}), 400

    cursor.execute("SELECT id FROM pratos WHERE nome = %s AND restaurante_id = %s",
                   (data["prato_nome"], restaurante["id"]))
    prato = cursor.fetchone()
    if not prato:
        return jsonify({"erro": "Prato não encontrado"}), 400

    cursor.execute("INSERT INTO pedidos (cliente_id, restaurante_id, prato_id) VALUES (%s, %s, %s)",
                   (cliente["id"], restaurante["id"], prato["id"]))
    db.commit()
    return jsonify({"mensagem": "Realizado com Sucesso"}), 201

# Listar clientes
@app.route("/clientes", methods=["GET"])
def listar_clientes():
    cursor.execute("SELECT nome FROM clientes")
    return jsonify(cursor.fetchall())

# Listar restaurantes
@app.route("/restaurantes", methods=["GET"])
def listar_restaurantes():
    cursor.execute("SELECT nome FROM restaurantes")
    return jsonify(cursor.fetchall())

# Listar pratos de um restaurante
@app.route("/pratos/<restaurante_nome>", methods=["GET"])
def listar_pratos(restaurante_nome):
    cursor.execute("SELECT id FROM restaurantes WHERE nome = %s", (restaurante_nome,))
    restaurante = cursor.fetchone()
    if not restaurante:
        return jsonify([])
    cursor.execute("SELECT nome FROM pratos WHERE restaurante_id = %s", (restaurante["id"],))
    return jsonify(cursor.fetchall())

if __name__ == "__main__":
    app.run(debug=True)
